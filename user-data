#cloud-config
hostname: node180
manage_etc_hosts: true
preserve_hostname: False
fqdn: node180.cloud.local

users:
  - name: vorlon
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/vorlon
    shell: /bin/bash
    lock_passwd: false
    ssh-authorized-keys:
     - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC5sUhei4scdtJnkhikFzgDpATy1X9vPme3XxQpdNK4Q/zQt767KfzXdirK6hwzZE7lWnXke4VPGQmoekwmWtn5KYnGjUPZNuejeWMgE0UPGqhuPiOz6Dp+utBe6tDyLimD2A0aMe0X6Nu0h2ovdsfrvDy05knvzFtvGB8EUt3oBSbYJctig6o09vNLgHHjZqaI7TUcNpt3TWoiExnv9owX3FNnnMLTol+Ieh8QKdy8AEdYuNJrU3t3g1mc5uFuZRh97xYDpW7zgXFv5SA53VbZ0f5/fOByTx04sZ4/BNQCnRtzKxdgNU105UDYBoUcwax2QhDGeeyGvHeI7l2soVIqQhTWDxqyCsx3pXxkj5u5hUpGQFOar5kJHbt8JoVd2dX3PicvBmwUWYnb8XtiO/adv/jnmpFqKGBygkmYTeB0JRitQjqEGNCN4MO7ykrS1q+w6iyTzWXHhKf3eHkabl6dfhHjimFy5GIto9cXgEJFGlKIEGrXCRGo5BxhjkXaHIU= root@node4
     - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEfoexTW+YG5avvLoOen1YT4QaC5w+zVlp9giXb2nF3zO/I7EkVvH8qBpkt9m/Iz6SSBHQb59tL553YKG8zM5qPA4noFeNcdGTvmYFCAYXii1c9VRzChIxwOL3AWB/gGGjY1WFr6ddOrtZUmYk39OsVnlENaLes/ti0eLYFyRuzumLjO+inYccB/URmgLNMnPfgQhIZC4yC+34PmABDRJDWNeM8YFNrzuPZkOMlARW7uiBzWokpU7SKZlJmJxjIU95w2ofOPzN7rlbexfGO7NRxcx5QSgIPPsH43cWVpQ2fwROiVrjZmUTCXOgKYI5cOMDCG9s2V+VY3I2ccIZidT2/hgfs6Nv55unsWQYiSYWEah79IAiygSuSN32WwCcfDEa1C0rhmORSS4xQyZ/Zj1fxXuuOWCiRqGNDX+AfeSRtABnzfqjFdIUrW+LKdwpkUnSnZX0j0a/h+MIF7GrZ0OabZBo+/DOOYcZnSqViWJkhyV+MUqa2C7pGfLuCA4lMHs= root@node2
     - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQD16epB9ZzdkY/Opqqc4wQ5r8gkXswQ1P4ei8JpFZ9g47VRuhkqvDZiCCpBF6N8s99aGRUo322RDMGYsNjnNGbQmJOoIUhWLSztr3UU9o1xinddnM6fY5iXO04waRdzKugOuleqGm8G+we7JhXoJ5aaJywvD5ZW4rZGxVJJaZqeO9f84ZkZdU82Y4uWU71JA5/5R7NSHq1McjhcytgTTb1OeqBo4W9lS75Mogd5X1MIR4rpVlHw0Ng7phUXA8ebrhF3MXItMXqeRBZBbriQ96HOt+MZHplBo3UBd6vIpVWisLXqwEt0XIQ5OQhmUTseQr07GdfZrajIwTC7QLMz5hCXCOusGJuUu+NfsRe86pIgV/NZRTB8gsvmQgPcCH2m8ObF+mFGZ0Vd/SZx4Rr/NliDFD7CNYwKLWjco4y9yCp7ov31gC09HGXncpbUh58YIDS+UIIGkm/2v5/VBDtcaApRGhQye/3xZXcIorjzVlVvRkvfXLO0msZmmQhBHXoLd1c= root@node3
     - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDKpSGIjiPJh1M/1mhFiTbLSqhhBqPl0o809dmZWg68YQYA/SvQGzRB4p9FCjgz2CN0Ynk2oWTSZ361v3J3KcA0ff9+/89OPEWSaBS03XSkEPVOa4L7ahCrSpR+Hv9nfCLt/sYF3UAQ0y+/nGcTMb2q60zzCgsYKiF4AT2Gqb9JuIWnUBciQ5mRPE3r2+eKTzhytM2/huTAgCnEFhUBZDafLo8vtyc+LUkIj55PVi2AL20e/IaTkiY2XAw/uwn04xRkFl63Xkkk+XLQBu8V4QztbgUV74H0TDbejt76a2l6gfKDdQBuY0oD6Ym6JPua65s7/WGNDqEQzN/ITwMf68azLmO5LBGHugjLGkABbsTscyq9tnHM0hof3KvK3WjbBRx27r6Jk1iJBx72RlH0FbxsCfJ6jtpqM283f3LGakTUZ8BEAFRPQ9xirSzX/DB90OucxH8ANcQjeRT+GUxN3dEFA5fsVAgEBZQ0vG5C70Me+MUj0rRPCoqa9TflaYy6Ptk= root@node1

ssh_pwauth: true
disable_root: false


apt:
  sources_list: |
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy main restricted
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy-updates main restricted
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy universe
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy-updates universe
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy multiverse
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy-updates multiverse
    deb https://nexus3.iblog.pro/repository/archive.ubuntu.com/ jammy-backports main restricted universe multiverse
    deb https://nexus3.iblog.pro/repository/security.ubuntu.com/ jammy-security main restricted
    deb https://nexus3.iblog.pro/repository/security.ubuntu.com/ jammy-security universe
    deb https://nexus3.iblog.pro/repository/security.ubuntu.com/ jammy-security multiverse

ca-certs:
  remove-defaults: false
  trusted:
  - |
     -----BEGIN CERTIFICATE-----
     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
     M/G+UfDX
     -----END CERTIFICATE-----
     

chpasswd:
  list: |
    vorlon:123
    root:root
  expire: false


write_files:
 - content: |
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC5sUhei4scdtJnkhikFzgDpATy1X9vPme3XxQpdNK4Q/zQt767KfzXdirK6hwzZE7lWnXke4VPGQmoekwmWtn5KYnGjUPZNuejeWMgE0UPGqhuPiOz6Dp+utBe6tDyLimD2A0aMe0X6Nu0h2ovdsfrvDy05knvzFtvGB8EUt3oBSbYJctig6o09vNLgHHjZqaI7TUcNpt3TWoiExnv9owX3FNnnMLTol+Ieh8QKdy8AEdYuNJrU3t3g1mc5uFuZRh97xYDpW7zgXFv5SA53VbZ0f5/fOByTx04sZ4/BNQCnRtzKxdgNU105UDYBoUcwax2QhDGeeyGvHeI7l2soVIqQhTWDxqyCsx3pXxkj5u5hUpGQFOar5kJHbt8JoVd2dX3PicvBmwUWYnb8XtiO/adv/jnmpFqKGBygkmYTeB0JRitQjqEGNCN4MO7ykrS1q+w6iyTzWXHhKf3eHkabl6dfhHjimFy5GIto9cXgEJFGlKIEGrXCRGo5BxhjkXaHIU= root@node4
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEfoexTW+YG5avvLoOen1YT4QaC5w+zVlp9giXb2nF3zO/I7EkVvH8qBpkt9m/Iz6SSBHQb59tL553YKG8zM5qPA4noFeNcdGTvmYFCAYXii1c9VRzChIxwOL3AWB/gGGjY1WFr6ddOrtZUmYk39OsVnlENaLes/ti0eLYFyRuzumLjO+inYccB/URmgLNMnPfgQhIZC4yC+34PmABDRJDWNeM8YFNrzuPZkOMlARW7uiBzWokpU7SKZlJmJxjIU95w2ofOPzN7rlbexfGO7NRxcx5QSgIPPsH43cWVpQ2fwROiVrjZmUTCXOgKYI5cOMDCG9s2V+VY3I2ccIZidT2/hgfs6Nv55unsWQYiSYWEah79IAiygSuSN32WwCcfDEa1C0rhmORSS4xQyZ/Zj1fxXuuOWCiRqGNDX+AfeSRtABnzfqjFdIUrW+LKdwpkUnSnZX0j0a/h+MIF7GrZ0OabZBo+/DOOYcZnSqViWJkhyV+MUqa2C7pGfLuCA4lMHs= root@node2
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQD16epB9ZzdkY/Opqqc4wQ5r8gkXswQ1P4ei8JpFZ9g47VRuhkqvDZiCCpBF6N8s99aGRUo322RDMGYsNjnNGbQmJOoIUhWLSztr3UU9o1xinddnM6fY5iXO04waRdzKugOuleqGm8G+we7JhXoJ5aaJywvD5ZW4rZGxVJJaZqeO9f84ZkZdU82Y4uWU71JA5/5R7NSHq1McjhcytgTTb1OeqBo4W9lS75Mogd5X1MIR4rpVlHw0Ng7phUXA8ebrhF3MXItMXqeRBZBbriQ96HOt+MZHplBo3UBd6vIpVWisLXqwEt0XIQ5OQhmUTseQr07GdfZrajIwTC7QLMz5hCXCOusGJuUu+NfsRe86pIgV/NZRTB8gsvmQgPcCH2m8ObF+mFGZ0Vd/SZx4Rr/NliDFD7CNYwKLWjco4y9yCp7ov31gC09HGXncpbUh58YIDS+UIIGkm/2v5/VBDtcaApRGhQye/3xZXcIorjzVlVvRkvfXLO0msZmmQhBHXoLd1c= root@node3
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDKpSGIjiPJh1M/1mhFiTbLSqhhBqPl0o809dmZWg68YQYA/SvQGzRB4p9FCjgz2CN0Ynk2oWTSZ361v3J3KcA0ff9+/89OPEWSaBS03XSkEPVOa4L7ahCrSpR+Hv9nfCLt/sYF3UAQ0y+/nGcTMb2q60zzCgsYKiF4AT2Gqb9JuIWnUBciQ5mRPE3r2+eKTzhytM2/huTAgCnEFhUBZDafLo8vtyc+LUkIj55PVi2AL20e/IaTkiY2XAw/uwn04xRkFl63Xkkk+XLQBu8V4QztbgUV74H0TDbejt76a2l6gfKDdQBuY0oD6Ym6JPua65s7/WGNDqEQzN/ITwMf68azLmO5LBGHugjLGkABbsTscyq9tnHM0hof3KvK3WjbBRx27r6Jk1iJBx72RlH0FbxsCfJ6jtpqM283f3LGakTUZ8BEAFRPQ9xirSzX/DB90OucxH8ANcQjeRT+GUxN3dEFA5fsVAgEBZQ0vG5C70Me+MUj0rRPCoqa9TflaYy6Ptk= root@node1
   path: /root/.ssh/authorized_keys
 - content: |
    Include /etc/ssh/sshd_config.d/*.conf
    Port 22
    ListenAddress 0.0.0.0
    SyslogFacility AUTH
    LogLevel INFO
    PermitRootLogin yes
    StrictModes yes
    MaxAuthTries 6
    ChallengeResponseAuthentication no
    UsePAM yes
    AllowTcpForwarding yes
    X11Forwarding no
    PrintMotd no
    AcceptEnv LANG LC_*
    Subsystem sftp  /usr/lib/openssh/sftp-server
    PasswordAuthentication yes
    
   path: /etc/ssh/sshd_config
 - content: |
    [global]
    timeout=360
    index-url=https://nexus3.iblog.pro/repository/pip/simple/
    index=https://nexus3.iblog.pro/repository/pip/
    cert=/etc/ssl/certs/ca-certificates.crt
    
   path: /etc/pip.conf

ntp:
  enabled: true
  ntp_client: systemd-timesyncd
  servers:
    - 0.ru.pool.ntp.org
    - 1.ru.pool.ntp.org
    - 2.ru.pool.ntp.org
    - 3.ru.pool.ntp.org

growpart:
  mode: auto
  devices: ['/']

timezone: Asia/Yekaterinburg
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - openssh-server
  - net-tools
  - tcpdump
  - mc
  - htop
  - iotop
  - iftop
  - language-pack-ru
  - pwgen
  - net-tools

output:
  all: ">> /var/log/cloud-init.log"

runcmd:
  - systemctl disable systemd-udevd.service
  - ssh-keygen -A
  - ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa  -q -P ""
  - ssh-keygen -t rsa -b 4096 -f /home/vorlon/.ssh/id_rsa  -q -P ""
  - cp /etc/netplan/50-cloud-init.yaml /etc/netplan/00-installer-config.yaml
  - echo "LANGUAGE=ru_RU:ru" &gt; /etc/default/locale
  - echo "LANG=ru_RU.UTF-8" &gt;&gt; /etc/default/locale
  - touch /etc/cloud/cloud-init.disabled
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - sed -i "s/^ExecStart=\/lib\/systemd\/systemd-networkd-wait-online/ExecStart=\/lib\/systemd\/systemd-networkd-wait-online --i enp1s0 -i enp2s0/"  /usr/lib/systemd/system/systemd-networkd-wait-online.service
  - cat /usr/lib/systemd/system/systemd-networkd-wait-online.service
  - apt update

final_message: "The system is finally up, after $UPTIME seconds"

power_state:
    delay: now
    mode: poweroff
    message: "shutdown after init"
    timeout: 20
